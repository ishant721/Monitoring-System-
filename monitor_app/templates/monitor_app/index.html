<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-online { color: #28a745; }
        .status-offline { color: #dc3545; }
        .card-header { background-color: #f8f9fa; }
        .table-responsive { max-height: 600px; overflow-y: auto; }
        .screenshot-thumbnail { max-width: 100px; max-height: 60px; cursor: pointer; }
        .modal-body img { max-width: 100%; height: auto; }
        .detail-row { margin-bottom: 0.5rem; }
        .detail-label { font-weight: bold; min-width: 200px; display: inline-block; }
        .productive-status { padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; }
        .productive { background-color: #d4edda; color: #155724; }
        .neutral { background-color: #fff3cd; color: #856404; }
        .idle { background-color: #f8d7da; color: #721c24; }
        .refresh-btn { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-chart-line me-2"></i>Agent Activity Dashboard
            </span>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-user me-1"></i>{{ user.email }}
                </span>
                <a href="{% url 'accounts:logout' %}" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Agent Status Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-desktop me-2"></i>Live Agent Status</h5>
                        <button class="btn btn-sm btn-success" onclick="showBulkControlModal()">
                            <i class="fas fa-cogs me-1"></i>Bulk Control
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="agent-status-container">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Loading agent status...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Historical Data -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Historical Activity Data</h5>
                        <div>
                            <select id="agent-filter" class="form-select form-select-sm d-inline-block w-auto me-2">
                                <option value="">All Agents</option>
                            </select>
                            <input type="number" id="limit-input" class="form-control form-control-sm d-inline-block w-auto me-2" 
                                   value="100" min="1" max="1000" placeholder="Limit">
                            <button class="btn btn-sm btn-primary" onclick="loadHistoricalData()">
                                <i class="fas fa-refresh me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Agent ID</th>
                                        <th>Timestamp</th>
                                        <th>Window Title</th>
                                        <th>Active Browser URL</th>
                                        <th>Screenshot</th>
                                        <th>Keystroke Count</th>
                                        <th>Mouse Event Count</th>
                                        <th>Upload Bytes</th>
                                        <th>Download Bytes</th>
                                        <th>Network Type</th>
                                        <th>Productive Status</th>
                                        <th>Activity Monitoring</th>
                                        <th>Network Monitoring</th>
                                        <th>Capture Interval</th>
                                    </tr>
                                </thead>
                                <tbody id="historical-data-body">
                                    <tr>
                                        <td colspan="15" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> Loading historical data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Keystroke Logs -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-keyboard me-2"></i>Keystroke Logs</h5>
                        <div>
                            <select id="keylog-type-filter" class="form-select form-select-sm d-inline-block w-auto me-2">
                                <option value="all">All Logs</option>
                                <option value="messaging">Messaging Only</option>
                                <option value="general">General Only</option>
                            </select>
                            <button class="btn btn-sm btn-primary" onclick="loadKeystrokeLogs()">
                                <i class="fas fa-refresh me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Agent ID</th>
                                        <th>User Email</th>
                                        <th>Timestamp</th>
                                        <th>Source App</th>
                                        <th>Key Sequence</th>
                                        <th>Type</th>
                                    </tr>
                                </thead>
                                <tbody id="keylog-data-body">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> Loading keystroke logs...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recorded Videos -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-video me-2"></i>Recorded Videos</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Agent ID</th>
                                        <th>User Email</th>
                                        <th>Filename</th>
                                        <th>Upload Time</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="video-data-body">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> Loading recorded videos...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Configuration Modal -->
    <div class="modal fade" id="agentConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configure Agent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="agent-config-form">
                        <input type="hidden" id="config-agent-id" name="agent_id">

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="capture-interval" class="form-label">Capture Interval (seconds)</label>
                                <input type="number" class="form-control" id="capture-interval" name="capture_interval" min="1" max="300">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Monitoring Settings</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="activity-monitoring" name="activity_monitoring_enabled">
                                    <label class="form-check-label" for="activity-monitoring">Activity Monitoring</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="network-monitoring" name="network_monitoring_enabled">
                                    <label class="form-check-label" for="network-monitoring">Network Monitoring</label>
                                </div>
                            </div>
                        </div>

                        <h6>Schedule Configuration</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Monday</label>
                                <div class="row">
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm" name="monday_start" placeholder="Start">
                                    </div>
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm" name="monday_end" placeholder="End">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tuesday</label>
                                <div class="row">
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm" name="tuesday_start" placeholder="Start">
                                    </div>
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm" name="tuesday_end" placeholder="End">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">Wednesday</label>
                                <div class="row">
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm" name="wednesday_start" placeholder="Start">
                                    </div>
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm" name="wednesday_end" placeholder="End">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Thursday</label>
                                <div class="row">
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm" name="thursday_start" placeholder="Start">
                                    </div>
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm" name="thursday_end" placeholder="End">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">Friday</label>
                                <div class="row">
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm" name="friday_start" placeholder="Start">
                                    </div>
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm" name="friday_end" placeholder="End">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Saturday</label>
                                <div class="row">
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm" name="saturday_start" placeholder="Start">
                                    </div>
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm" name="saturday_end" placeholder="End">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">Sunday</label>
                                <div class="row">
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm" name="sunday_start" placeholder="Start">
                                    </div>
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm" name="sunday_end" placeholder="End">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveAgentConfig()">Save Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Control Modal -->
    <div class="modal fade" id="bulkControlModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bulk Agent Control</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Action</label>
                        <select class="form-select" id="bulk-action">
                            <option value="">Choose action...</option>
                            <option value="start_recording">Start Recording (All Agents)</option>
                            <option value="stop_recording">Stop Recording (All Agents)</option>
                        </select>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        This action will be applied to all agents you have permission to control.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="executeBulkAction()">Execute Action</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Screenshot Modal -->
    <div class="modal fade" id="screenshotModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Screenshot</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="screenshot-full" src="" alt="Screenshot">
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Refresh Button -->
    <button class="btn btn-primary btn-lg refresh-btn" onclick="refreshAllData()" title="Refresh All Data">
        <i class="fas fa-sync-alt"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Access token from Django context
        const ACCESS_TOKEN = '{{ access_token }}';

        // API Headers
        const getHeaders = () => ({
            'Authorization': `Bearer ${ACCESS_TOKEN}`,
            'Content-Type': 'application/json'
        });

        // Format timestamp
        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        // Format bytes
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Load agent status
        async function loadAgentStatus() {
            try {
                const response = await fetch('/monitor/api/agents/status/', {
                    headers: getHeaders()
                });
                const agents = await response.json();

                const container = document.getElementById('agent-status-container');

                if (agents.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No agents found.</div>';
                    return;
                }

                // Populate agent filter dropdown
                const agentFilter = document.getElementById('agent-filter');
                agentFilter.innerHTML = '<option value="">All Agents</option>';
                agents.forEach(agent => {
                    agentFilter.innerHTML += `<option value="${agent.agent_id}">${agent.agent_id} (${agent.user_email})</option>`;
                });

                let html = '<div class="row">';
                agents.forEach(agent => {
                    const statusClass = agent.is_online ? 'status-online' : 'status-offline';
                    const statusText = agent.is_online ? 'Online' : 'Offline';

                    html += `
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-desktop me-2"></i>${agent.agent_id.substring(0, 12)}...
                                        </h6>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary btn-sm" onclick="showAgentConfig('${agent.agent_id}')" title="Configure">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                            ${agent.is_recording ? 
                                                `<button class="btn btn-outline-danger btn-sm" onclick="controlAgent('${agent.agent_id}', 'stop', 'screen_recording')" title="Stop Recording">
                                                    <i class="fas fa-stop"></i>
                                                </button>` :
                                                `<button class="btn btn-outline-success btn-sm" onclick="controlAgent('${agent.agent_id}', 'start', 'screen_recording')" title="Start Recording">
                                                    <i class="fas fa-record-vinyl"></i>
                                                </button>`
                                            }
                                        </div>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">User:</span> ${agent.user_email}
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Status:</span> 
                                        <i class="fas fa-circle ${statusClass}"></i> ${statusText}
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Last Seen:</span> ${formatTimestamp(agent.last_seen)}
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Recording:</span> 
                                        ${agent.is_recording ? '<i class="fas fa-record-vinyl text-danger"></i> Yes' : '<i class="fas fa-stop text-secondary"></i> No'}
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Interval:</span> ${agent.capture_interval_seconds}s
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Window:</span> ${agent.window_title || 'N/A'}
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Browser URL:</span> 
                                        ${agent.active_browser_url ? `<a href="${agent.active_browser_url}" target="_blank" class="text-truncate d-inline-block" style="max-width: 200px;">${agent.active_browser_url}</a>` : 'N/A'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading agent status:', error);
                document.getElementById('agent-status-container').innerHTML = 
                    '<div class="alert alert-danger">Error loading agent status.</div>';
            }
        }

        // Load historical data
        async function loadHistoricalData() {
            try {
                const agentFilter = document.getElementById('agent-filter').value;
                const limit = document.getElementById('limit-input').value || 100;

                let url = `/monitor/api/agents/history/?limit=${limit}`;
                if (agentFilter) {
                    url += `&agent_id=${agentFilter}`;
                }

                const response = await fetch(url, {
                    headers: getHeaders()
                });
                const data = await response.json();

                const tbody = document.getElementById('historical-data-body');

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="15" class="text-center">No historical data found.</td></tr>';
                    return;
                }

                let html = '';
                data.forEach((item, index) => {
                    const productiveClass = item.productive_status.toLowerCase();
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><span class="text-monospace">${item.agent_id.substring(0, 12)}...</span></td>
                            <td>${formatTimestamp(item.timestamp)}</td>
                            <td>${item.window_title || 'N/A'}</td>
                            <td>
                                ${item.active_browser_url ? 
                                    `<a href="${item.active_browser_url}" target="_blank" class="text-truncate d-inline-block" style="max-width: 200px;">${item.active_browser_url}</a>` : 
                                    'N/A'
                                }
                            </td>
                            <td>
                                ${item.screenshot_url ? 
                                    `<img src="${item.screenshot_url}" class="screenshot-thumbnail" onclick="showScreenshot('${item.screenshot_url}')" alt="Screenshot">` : 
                                    'N/A'
                                }
                            </td>
                            <td>${item.keystroke_count}</td>
                            <td>${item.mouse_event_count}</td>
                            <td>${formatBytes(item.upload_bytes || 0)}</td>
                            <td>${formatBytes(item.download_bytes || 0)}</td>
                            <td>${item.network_type || 'N/A'}</td>
                            <td><span class="productive-status ${productiveClass}">${item.productive_status}</span></td>
                            <td>${item.is_activity_monitoring_enabled ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}</td>
                            <td>${item.is_network_monitoring_enabled ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}</td>
                            <td>${item.capture_interval_seconds}s</td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
            } catch (error) {
                console.error('Error loading historical data:', error);
                document.getElementById('historical-data-body').innerHTML = 
                    '<tr><td colspan="15" class="text-center text-danger">Error loading historical data.</td></tr>';
            }
        }

        // Load keystroke logs
        async function loadKeystrokeLogs() {
            try {
                const logType = document.getElementById('keylog-type-filter').value;
                let url = `/monitor/api/keylog/history/?limit=500`;
                if (logType !== 'all') {
                    url += `&log_type=${logType}`;
                }

                const response = await fetch(url, {
                    headers: getHeaders()
                });
                const data = await response.json();

                const tbody = document.getElementById('keylog-data-body');

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No keystroke logs found.</td></tr>';
                    return;
                }

                let html = '';
                data.forEach(log => {
                    html += `
                        <tr>
                            <td><span class="text-monospace">${log.agent_id.substring(0, 12)}...</span></td>
                            <td>${log.user_email}</td>
                            <td>${formatTimestamp(log.timestamp)}</td>
                            <td>${log.source_app}</td>
                            <td class="text-monospace" style="max-width: 300px; word-break: break-all;">${log.key_sequence}</td>
                            <td>
                                ${log.is_messaging ? 
                                    '<span class="badge bg-primary">Messaging</span>' : 
                                    '<span class="badge bg-secondary">General</span>'
                                }
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
            } catch (error) {
                console.error('Error loading keystroke logs:', error);
                document.getElementById('keylog-data-body').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Error loading keystroke logs.</td></tr>';
            }
        }

        // Load recorded videos
        async function loadRecordedVideos() {
            try {
                const response = await fetch('/monitor/api/recordings/videos/?limit=100', {
                    headers: getHeaders()
                });
                const data = await response.json();

                const tbody = document.getElementById('video-data-body');

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No recorded videos found.</td></tr>';
                    return;
                }

                let html = '';
                data.forEach(video => {
                    html += `
                        <tr>
                            <td>${video.id}</td>
                            <td><span class="text-monospace">${video.agent_id.substring(0, 12)}...</span></td>
                            <td>${video.user_email}</td>
                            <td>${video.filename}</td>
                            <td>${formatTimestamp(video.upload_time)}</td>
                            <td>
                                ${video.video_url ? 
                                    `<a href="${video.video_url}" target="_blank" class="btn btn-sm btn-primary">
                                        <i class="fas fa-play me-1"></i>View
                                    </a>` : 
                                    'N/A'
                                }
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
            } catch (error) {
                console.error('Error loading recorded videos:', error);
                document.getElementById('video-data-body').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Error loading recorded videos.</td></tr>';
            }
        }

        // Show screenshot in modal
        function showScreenshot(url) {
            document.getElementById('screenshot-full').src = url;
            new bootstrap.Modal(document.getElementById('screenshotModal')).show();
        }

        // Refresh all data
        function refreshAllData() {
            loadAgentStatus();
            loadHistoricalData();
            loadKeystrokeLogs();
            loadRecordedVideos();
        }

        // Control agent (start/stop recording)
        async function controlAgent(agentId, action, featureBundle) {
            try {
                const response = await fetch(`/monitor/api/agents/${agentId}/control/${action}/`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        feature_bundle: featureBundle
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`Success: ${result.message}`);
                    loadAgentStatus(); // Refresh to show updated status
                } else {
                    alert(`Error: ${result.error || 'Unknown error occurred'}`);
                }
            } catch (error) {
                console.error('Error controlling agent:', error);
                alert('Error: Failed to send control command');
            }
        }

        // Show agent configuration modal
        async function showAgentConfig(agentId) {
            try {
                // Load current agent data
                const response = await fetch('/monitor/api/agents/status/', {
                    headers: getHeaders()
                });
                const agents = await response.json();
                const agent = agents.find(a => a.agent_id === agentId);

                if (!agent) {
                    alert('Agent not found');
                    return;
                }

                // Populate form
                document.getElementById('config-agent-id').value = agentId;
                document.getElementById('capture-interval').value = agent.capture_interval_seconds;
                document.getElementById('activity-monitoring').checked = agent.is_activity_monitoring_enabled;
                document.getElementById('network-monitoring').checked = agent.is_network_monitoring_enabled;

                // Populate schedule
                if (agent.schedule) {
                    Object.keys(agent.schedule).forEach(day => {
                        const schedule = agent.schedule[day];
                        const startInput = document.querySelector(`input[name="${day}_start"]`);
                        const endInput = document.querySelector(`input[name="${day}_end"]`);
                        if (startInput) startInput.value = schedule.start || '';
                        if (endInput) endInput.value = schedule.end || '';
                    });
                }

                new bootstrap.Modal(document.getElementById('agentConfigModal')).show();
            } catch (error) {
                console.error('Error loading agent config:', error);
                alert('Error loading agent configuration');
            }
        }

        // Save agent configuration
        async function saveAgentConfig() {
            try {
                const form = document.getElementById('agent-config-form');
                const formData = new FormData(form);
                const agentId = formData.get('agent_id');

                const schedule = {};
                ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
                    schedule[day] = {
                        start: formData.get(`${day}_start`) || null,
                        end: formData.get(`${day}_end`) || null
                    };
                });

                const configData = {
                    capture_interval: parseInt(formData.get('capture_interval')),
                    activity_monitoring_enabled: formData.has('activity_monitoring_enabled'),
                    network_monitoring_enabled: formData.has('network_monitoring_enabled'),
                    schedule: schedule
                };

                const response = await fetch(`/monitor/api/agent/${agentId}/update-config/`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(configData)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Configuration updated successfully');
                    bootstrap.Modal.getInstance(document.getElementById('agentConfigModal')).hide();
                    loadAgentStatus(); // Refresh data
                } else {
                    alert(`Error: ${result.error || 'Failed to update configuration'}`);
                }
            } catch (error) {
                console.error('Error saving agent config:', error);
                alert('Error saving configuration');
            }
        }

        // Show bulk control modal
        function showBulkControlModal() {
            new bootstrap.Modal(document.getElementById('bulkControlModal')).show();
        }

        // Execute bulk action
        async function executeBulkAction() {
            const action = document.getElementById('bulk-action').value;
            if (!action) {
                alert('Please select an action');
                return;
            }

            const [command, featureBundle] = action.split('_');

            try {
                // Get all agents first
                const response = await fetch('/monitor/api/agents/status/', {
                    headers: getHeaders()
                });
                const agents = await response.json();

                if (agents.length === 0) {
                    alert('No agents found');
                    return;
                }

                // Execute action for each agent
                const promises = agents.map(agent => 
                    controlAgent(agent.agent_id, command, 'screen_recording')
                );

                await Promise.all(promises);

                bootstrap.Modal.getInstance(document.getElementById('bulkControlModal')).hide();
                alert(`Bulk action "${action}" executed for ${agents.length} agents`);loadAgentStatus();
            } catch (error) {
                console.error('Error executing bulk action:', error);
                alert('Error executing bulk action');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            if (!ACCESS_TOKEN) {
                alert('No access token available. Please refresh the page.');
                return;
            }

            refreshAllData();

            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadAgentStatus();
            }, 30000);
        });
    </script>
</body>
</html>